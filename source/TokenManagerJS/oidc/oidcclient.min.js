function log(){}function copy(n,t){t=t||{};for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function rand(){return((Date.now()+Math.random())*Math.random()).toString().replace(".","")}function error(n){return Promise.reject(Error(n))}function parseOidcResult(n){var t,e;log("parseOidcResult");n=n||location.hash;t=n.lastIndexOf("#");t>=0&&(n=n.substr(t+1));for(var i={},u=/([^&=]+)=([^&]*)/g,r,f=0;r=u.exec(n);)if(i[decodeURIComponent(r[1])]=decodeURIComponent(r[2]),f++>50)return{error:"Response exceeded expected number of parameters"};for(e in i)return i}function getJson(n,t){return log("getJson",n),new Promise(function(i,r){var u=new XMLHttpRequest;u.open("GET",n);u.responseType="json";t&&u.setRequestHeader("Authorization","Bearer "+t);u.onload=function(){if(u.status===200){var n=u.response;typeof n=="string"&&(n=JSON.parse(n));i(n)}else r(Error(u.statusText+"("+u.status+")"))};u.onerror=function(){r(Error("Network error"))};u.send()})}function OidcClient(n){this._settings=n||{};typeof this._settings.load_user_profile=="undefined"&&(this._settings.load_user_profile=!0);this._settings.authority&&this._settings.authority.indexOf(".well-known/openid-configuration")<0&&(this._settings.authority[this._settings.authority.length-1]!="/"&&(this._settings.authority+="/"),this._settings.authority+=".well-known/openid-configuration");this._settings.response_type||(this._settings.response_type="id_token token");this._settings.store||(this._settings.store=window.localStorage);Object.defineProperty(this,"isOidc",{get:function(){if(this._settings.response_type){var n=this._settings.response_type.split(/\s+/g).filter(function(n){return n==="id_token"});return!!n[0]}return!1}});Object.defineProperty(this,"isOAuth",{get:function(){if(this._settings.response_type){var n=this._settings.response_type.split(/\s+/g).filter(function(n){return n==="token"});return!!n[0]}return!1}})}var requestDataKey="OidcClient.requestDataKey";OidcClient.prototype.redirectForToken=function(){log("OidcClient.redirectForToken");this.createTokenRequestAsync().then(function(n){window.location=n.url},function(n){console.error(n)})};OidcClient.prototype.redirectForLogout=function(n){log("OidcClient.redirectForLogout");var t=this._settings;this.loadMetadataAsync().then(function(i){i.end_session_endpoint||console.error("No end_session_endpoint in metadata");var r=i.end_session_endpoint;n&&t.post_logout_redirect_uri&&(r+="?post_logout_redirect_uri="+t.post_logout_redirect_uri,r+="&id_token_hint="+n);window.location=r},function(n){console.error(n)})};OidcClient.prototype.loadAuthorizationEndpoint=function(){return(log("OidcClient.loadAuthorizationEndpoint"),this._settings.authorization_endpoint)?Promise.resolve(this._settings.authorization_endpoint):this._settings.authority?this.loadMetadataAsync().then(function(n){return n.authorization_endpoint?n.authorization_endpoint:error("Metadata does not contain authorization_endpoint")}):error("No authorization_endpoint configured")};OidcClient.prototype.createTokenRequestAsync=function(){log("OidcClient.createTokenRequestAsync");var n=this,t=n._settings;return n.loadAuthorizationEndpoint().then(function(i){var e=rand(),r=i+"?state="+encodeURIComponent(e),u,o,s,f;return n.isOidc&&(u=rand(),r+="&nonce="+encodeURIComponent(u)),o=["client_id","redirect_uri","response_type","scope"],o.forEach(function(n){var i=t[n];i&&(r+="&"+n+"="+encodeURIComponent(i))}),s=["prompt","display","max_age","ui_locales","id_token_hint","login_hint","acr_values"],s.forEach(function(n){var i=t[n];i&&(r+="&"+n+"="+encodeURIComponent(i))}),f={oidc:n.isOidc,oauth:n.isOAuth,state:e},u&&(f.nonce=u),t.store.setItem(requestDataKey,JSON.stringify(f)),{data:f,url:r}})};OidcClient.prototype.loadMetadataAsync=function(){log("OidcClient.loadMetadataAsync");var n=this._settings;return n.metadata?Promise.resolve(n.metadata):n.authority?getJson(n.authority).then(function(t){return n.metadata=t,t},function(n){return error("Failed to load metadata ("+n.message+")")}):error("No authority configured")};OidcClient.prototype.loadX509SigningKeyAsync=function(){function t(n){if(!n.keys||!n.keys.length)return error("Signing keys empty");var t=n.keys[0];return t.kty!="RSA"?error("Signing key not RSA"):!t.x5c||!t.x5c.length?error("RSA keys empty"):Promise.resolve(t.x5c[0])}log("OidcClient.loadX509SigningKeyAsync");var n=this._settings;return n.jwks?t(n.jwks):this.loadMetadataAsync().then(function(i){return i.jwks_uri?getJson(i.jwks_uri).then(function(i){return n.jwks=i,t(i)},function(n){return error("Failed to load signing keys ("+n.message+")")}):error("Metadata does not contain jwks_uri")})};OidcClient.prototype.validateIdTokenAsync=function(n,t,i){log("OidcClient.validateIdTokenAsync");var r=this,u=r._settings;return r.loadX509SigningKeyAsync().then(function(f){var o=new KJUR.jws.JWS,e;return o.verifyJWSByPemX509Cert(n,f)?(e=JSON.parse(o.parsedJWS.payloadS),t!==e.nonce)?error("Invalid nonce"):r.loadMetadataAsync().then(function(n){if(e.iss!==n.issuer)return error("Invalid issuer");if(e.aud!==u.client_id)return error("Invalid audience");var t=parseInt(Date.now()/1e3),f=t-e.iat;return f>300?error("Token issued too long ago"):e.exp<t?error("Token expired"):i&&u.load_user_profile?r.loadUserProfile(i,e).then(function(n){return n}):e}):error("JWT failed to validate")})};OidcClient.prototype.validateAccessTokenAsync=function(n,t){if(log("OidcClient.validateAccessTokenAsync"),!n.at_hash)return error("No at_hash in id_token");var i=KJUR.crypto.Util.sha256(t),r=i.substr(0,i.length/2),u=hextob64u(r);return u!==n.at_hash?error("at_hash failed to validate"):Promise.resolve()};OidcClient.prototype.loadUserProfile=function(n,t){return log("OidcClient.loadUserProfile"),this.loadMetadataAsync().then(function(i){return i.userinfo_endpoint?getJson(i.userinfo_endpoint,n).then(function(n){return copy(n,t)}):Promise.reject(Error("Metadata does not contain userinfo_endpoint"))})};OidcClient.prototype.validateIdTokenAndAccessTokenAsync=function(n,t,i){log("OidcClient.validateIdTokenAndAccessTokenAsync");var r=this;return r.validateIdTokenAsync(n,t,i).then(function(n){return r.validateAccessTokenAsync(n,i).then(function(){return n})})};OidcClient.prototype.readResponseAsync=function(n){var t,r;log("OidcClient.readResponseAsync");var u=this,f=u._settings,i=f.store.getItem(requestDataKey);if((f.store.removeItem(requestDataKey),!i)||(i=JSON.parse(i),!i))return error("No request state loaded");if(!i.state)return error("No state loaded");if(t=parseOidcResult(n),!t)return error("No OIDC response");if(t.error)return error(t.error);if(t.state!==i.state)return error("Invalid state");if(i.oidc){if(!t.id_token)return error("No identity token");if(!i.nonce)return error("No nonce loaded")}if(i.oauth){if(!t.access_token)return error("No access token");if(t.token_type!=="Bearer")return error("Invalid token type");if(!t.expires_in)return error("No token expiration")}return r=Promise.resolve(),i.oidc&&i.oauth?r=u.validateIdTokenAndAccessTokenAsync(t.id_token,i.nonce,t.access_token):i.oidc&&(r=u.validateIdTokenAsync(t.id_token,i.nonce)),r.then(function(n){return{id_token:n,id_token_jwt:t.id_token,access_token:t.access_token,expires_in:t.expires_in}})};
//# sourceMappingURL=oidcclient.min.js.map
