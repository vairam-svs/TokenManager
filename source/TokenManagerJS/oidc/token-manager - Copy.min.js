(function(){"use strict";function o(n,t){t=t||{};for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function t(n){this._settings=n||{};this._settings.authority&&this._settings.authority.indexOf(".well-known/openid-configuration")<0&&(this._settings.authority[this._settings.authority.length-1]!="/"&&(this._settings.authority+="/"),this._settings.authority+=".well-known/openid-configuration");this._settings.response_type||(this._settings.response_type="id_token token");this._settings.store||(this._settings.store=window.localStorage);Object.defineProperty(this,"isOidc",{get:function(){return this._settings.response_type&&!!this._settings.response_type.split(/\s+/g).filter(function(n){return n==="id_token"})[0],!1}});Object.defineProperty(this,"isOAuth",{get:function(){return this._settings.response_type&&!!this._settings.response_type.split(/\s+/g).filter(function(n){return n==="token"})[0],!1}})}function s(){return((Date.now()+Math.random())*Math.random()).toString().replace(".","")}function n(n){return Promise.reject(Error(n))}function c(n){var t,e;n=n||location.hash;t=n.lastIndexOf("#");t>=0&&(n=n.substr(t+1));for(var i={},u=/([^&=]+)=([^&]*)/g,r,f=0;r=u.exec(n);)if(i[decodeURIComponent(r[1])]=decodeURIComponent(r[2]),f++>50)return{error:"Response exceeded expected number of parameters"};for(e in i)return i}function e(n,t){return new Promise(function(i,r){var u=new XMLHttpRequest;u.open("GET",n);u.responseType="json";t&&u.setRequestHeader("Authorization","Bearer "+t);u.onload=function(){if(u.status===200){var n=u.response;typeof n=="string"&&(n=JSON.parse(n));i(n)}else r(Error(u.statusText+"("+u.status+")"))};u.onerror=function(){r(Error("Network error"))};u.send()})}function r(n,t,i,r){this.id_token=n;this.id_token_jwt=t;this.access_token=i;this.expires_at=parseInt(r);Object.defineProperty(this,"expired",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at<n}});Object.defineProperty(this,"expires_in",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at-n}})}function h(n){this.url=n}function i(n){this._settings=n||{};this._settings.persist=this._settings.persist||!0;this._settings.store=this._settings.store||window.localStorage;this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[]};Object.defineProperty(this,"id_token",{get:function(){if(this._token)return this._token.id_token}});Object.defineProperty(this,"id_token_jwt",{get:function(){if(this._token)return this._token.id_token_jwt}});Object.defineProperty(this,"access_token",{get:function(){if(this._token&&!this._token.expired)return this._token.access_token}});Object.defineProperty(this,"expired",{get:function(){return this._token?this._token.expired:!0}});Object.defineProperty(this,"expires_in",{get:function(){return this._token?this._token.expires_in:0}});Object.defineProperty(this,"expires_at",{get:function(){return this._token?this._token.expires_at:0}});l(this);k(this);b(this);var t=this;window.setTimeout(function(){w(t)},0)}function l(n){var t,i;n._settings.persist&&(t=n._settings.store.getItem(u),t&&(i=r.fromJSON(t),i.expired||(n._token=i)))}function a(n){n._callbacks.tokenRemovedCallbacks.forEach(function(n){n()})}function v(n){n._callbacks.tokenExpiringCallbacks.forEach(function(n){n()})}function y(n){n._callbacks.tokenExpiredCallbacks.forEach(function(n){n()})}function p(n){n._callbacks.tokenObtainedCallbacks.forEach(function(n){n()})}function w(n){function i(){t=null;v(n)}function r(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(i,n*1e3)}function u(){if(r(),!n.expired){var t=n.expires_in;t>60?f(t-60):i()}}var t=null;u();n.addOnTokenObtained(u);n.addOnTokenRemoved(r)}function b(n){n._settings.silent_redirect_uri&&n._settings.silent_renew&&n.addOnTokenExpiring(function(){n.renewTokenSilentAsync().catch(function(n){console.error(n.message||n)})})}function k(n){function u(){t=null;n._token&&n.saveToken(null);y(n)}function i(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(u,n*1e3)}function r(){i();n.expires_in>0&&f(n.expires_in+1)}var t=null;r();n.addOnTokenObtained(r);n.addOnTokenRemoved(i)}var f="OidcClient.requestDataKey",u;t.prototype.redirectForToken=function(){this.createTokenRequestAsync().then(function(n){window.location=n.url},function(n){console.error(n)})};t.prototype.redirectForLogout=function(n){var t=this._settings;this.loadMetadataAsync().then(function(i){i.end_session_endpoint||console.error("No end_session_endpoint in metadata");var r=i.end_session_endpoint;n&&t.post_logout_redirect_uri&&(r+="?post_logout_redirect_uri="+t.post_logout_redirect_uri,r+="&id_token_hint="+n);window.location=r},function(n){console.error(n)})};t.prototype.loadAuthorizationEndpoint=function(){return this._settings.authorization_endpoint?Promise.resolve(this._settings.authorization_endpoint):this._settings.authority?this.loadMetadataAsync().then(function(t){return t.authorization_endpoint?t.authorization_endpoint:n("Metadata does not contain authorization_endpoint")}):n("No authorization_endpoint configured")};t.prototype.createTokenRequestAsync=function(){var n=this,t=n._settings;return n.loadAuthorizationEndpoint().then(function(i){var o=s(),r=i+"?state="+encodeURIComponent(o),u,h,c,e;return n.isOidc&&(u=s(),r+="&nonce="+encodeURIComponent(u)),h=["client_id","redirect_uri","response_type","scope"],h.forEach(function(n){var i=t[n];i&&(r+="&"+n+"="+encodeURIComponent(i))}),c=["prompt","display","max_age","ui_locales","id_token_hint","login_hint","acr_values"],c.forEach(function(n){var i=t[n];i&&(r+="&"+n+"="+encodeURIComponent(i))}),e={oidc:n.isOidc,oauth:n.isOAuth,state:o},u&&(e.nonce=u),t.store.setItem(f,JSON.stringify(e)),{data:e,url:r}})};t.prototype.loadMetadataAsync=function(){var t=this._settings;return t.metadata&&Promise.resolve(t.metadata),t.authority||n("No authority configured"),e(t.authority).then(function(n){return t.metadata=n,n},function(t){n("Failed to load metadata ("+t.message+")")})};t.prototype.loadX509SigningKeyAsync=function(){function i(t){if(!t.keys||!t.keys.length)return n("Signing keys empty");var i=t.keys[0];return i.kty!="RSA"?n("Signing key not RSA"):!i.x5c||!i.x5c.length?n("RSA keys empty"):Promise.resolve(i.x5c[0])}var t=this._settings;return t.jwks?i(t.jwks):this.loadMetadataAsync().then(function(r){return r.jwks_uri?e(r.jwks_uri).then(function(n){return t.jwks=n,i(n)},function(t){return n("Failed to load signing keys ("+t.message+")")}):n("Metadata does not contain jwks_uri")})};t.prototype.validateIdTokenAsync=function(t,i){return this.loadX509SigningKeyAsync().then(function(r){var f=new KJUR.jws.JWS,u;return f.verifyJWSByPemX509Cert(t,r)?(u=JSON.parse(f.parsedJWS.payloadS),i!==u.nonce)?n("Invalid nonce"):u:n("JWT failed to validate")})};t.prototype.validateAccessTokenAsync=function(t,i,r){return t.at_hash?this.loadX509SigningKeyAsync().then(function(u){var f=new KJUR.jws.JWS;if(f.verifyJWSByPemX509Cert(i,u)){if(f.parsedJWS.headP.alg!="RS256")return n("JWT signature alg not supported");var e=KJUR.crypto.Util.sha256(r),o=e.substr(0,e.length/2),s=hextob64u(o);if(s!==t.at_hash)return n("at_hash failed to validate")}else return n("JWT failed to validate")}):n("No at_hash in id_token")};t.prototype.loadUserProfile=function(n,t){return this.loadMetadataAsync().then(function(i){return i.userinfo_endpoint?e(i.userinfo_endpoint,n).then(function(n){return o(n,t)}):Promise.reject(Error("Metadata does not contain userinfo_endpoint"))})};t.prototype.validateIdTokenAndAccessTokenAsync=function(t,i){var r=this;return r.validateIdTokenAsync(t,i).then(function(t){return t?r.loadMetadataAsync().then(function(i){if(t.iss!==i.issuer)return n("Invalid issuer");if(t.aud!==settings.client_id)return n("Invalid audience");var u=parseInt(Date.now()/1e3),f=u-t.iat;return f>300?n("Token issued too long ago"):t.exp<u?n("Token expired"):r.validateAccessTokenAsync(t,result.id_token,token).then(function(){return r.loadUserProfile(token,t)})}):n("Invalid identity token")})};t.prototype.readResponseAsync=function(t){var e=this,o=e._settings,r=o.store.getItem(f),i,u;if((o.store.removeItem(f),!r)||(r=JSON.parse(r),!r))return n("No request state loaded");if(!r.state)return n("No state loaded");if(i=c(t),!i)return n("No OIDC response");if(i.error)return n(i.error);if(i.state!==r.state)return n("Invalid state");if(r.oidc){if(!i.id_token)return n("No identity token");if(!r.nonce)return n("No nonce loaded")}if(r.oauth){if(!i.access_token)return n("No access token");if(i.token_type!=="Bearer")return n("Invalid token type");if(!i.expires_in)return n("No token expiration")}return u=Promise.resolve(),r.oidc&&r.oauth&&(u=e.validateIdTokenAndAccessTokenAsync(i.id_token,r.nonce,i.access_token)),r.oidc&&(u=e.validateIdTokenAsync(i.id_token,r.nonce)),u.then(function(n){return{id_token:n,id_token_jwt:i.id_token,access_token:i.token,expires_in:i.expires_in}})};r.fromResponse=function(n){var t=parseInt(Date.now()/1e3),i=t+parseInt(n.expires_in);return new r(n.id_token,n.id_token_jwt,n.access_token,i)};r.fromJSON=function(n){if(n)try{var t=JSON.parse(n);return new r(t.id_token,t.id_token_jwt,t.access_token,t.expires_at)}catch(i){}return new r(null,0,null)};r.prototype.toJSON=function(){return JSON.stringify({id_token:this.id_token,id_token_jwt:this.id_token_jwt,access_token:this.access_token,expires_at:this.expires_at})};h.prototype.loadAsync=function(n){return(n=n||this.url,!n)?Promise.reject("No url provided"):new Promise(function(t,i){function f(){window.removeEventListener("message",e,!1);r&&window.clearTimeout(r);r=null;u.remove()}function o(){f();i()}function e(n){r&&n.origin===location.protocol+"//"+location.host&&(f(),t(n.data))}var u=$('<iframe style="display:none"><\/iframe>').appendTo("body"),r=window.setTimeout(o,5e3);window.addEventListener("message",e,!1);u.attr("src",n)})};u="TokenManager.token";i.prototype.saveToken=function(n){this._token=n;this._settings.persist&&!this.expired?this._settings.store.setItem(u,n.toJSON()):this._settings.store.removeItem(u);n?p(this):a(this)};i.prototype.addOnTokenRemoved=function(n){this._callbacks.tokenRemovedCallbacks.push(n)};i.prototype.addOnTokenObtained=function(n){this._callbacks.tokenObtainedCallbacks.push(n)};i.prototype.addOnTokenExpiring=function(n){this._callbacks.tokenExpiringCallbacks.push(n)};i.prototype.addOnTokenExpired=function(n){this._callbacks.tokenExpiredCallbacks.push(n)};i.prototype.removeToken=function(){this.saveToken(null)};i.prototype.redirectForToken=function(){var n=new t(this._settings);n.redirectForToken()};i.prototype.redirectForLogout=function(){var n=new t(this._settings),i=this.id_token_jwt;this.removeToken();n.redirectForLogout(i)};i.prototype.processTokenCallbackAsync=function(n){var i=this,r=new t(i._settings);return r.readResponseAsync(n).then(function(n){i.saveToken(n)})};i.prototype.renewTokenSilentAsync=function(){var i=this,n,r;return i._settings.silent_redirect_uri?(n=o(i._settings),n.redirect_uri=n.silent_redirect_uri,n.prompt="none",r=new t(n),r.createTokenRequestAsync().then(function(n){var t=new h(n.url);return t.loadAsync().then(function(n){return r.readResponseAsync(n).then(function(n){i.saveToken(n)})})})):Promise.reject("silent_redirect_uri not configured")};i.prototype.processTokenCallbackSilent=function(){if(window.top&&window!==window.top){var n=window.location.hash;n&&window.top.postMessage(n,location.protocol+"//"+location.host)}};window.TokenManager=i})();